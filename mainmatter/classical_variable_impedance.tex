\chapter{Stability methods in classical variable impedance control}
\label{chapter:classical_variable_impedance}

% TODO: Check control barrier function part. I'm focusing on stability so this should be clear. `A control barrier function can be seen as the converce of a Lyapunov Control function, keeping the system outside of a given boundary`.
% TODO: Check contraction and diffeomorphism papers.

As shown in section \ref{section:variable_impedance_control}, the beneficial passivity property of constant (or fixed) impedance controllers no longer holds for variable impedance controllers, meaning the system can become unstable due to the control. Since no closed-loop solution exists for most interaction tasks as the environment model is unknown or uncertain, a classic stability analysis cannot be applied. Therefore, most authors have resorted to Lyapunov's stability theory and the concept of passivity to prove that systems controlled by variable impedance stay stable when interacting with these unknown environments. In the literature, two main groups of methods can be found for ensuring the stability of variable impedance controllers: Solutions that try to enforce the passivity online through \textbf{pacifying control algorithm} and solutions that use \textbf{Stability constraints} to ensure the passivity of a given controller or impedance profile offline. The following sections discuss the methods used with classical variable impedance controllers like adaptive and optimal controllers. The methods used in learning-based variable impedance controllers are described in the next chapter.

\section{Pacifying control algorithms}

\subsection{Energy-tanks}

One of the first authors to use a pacifying control algorithm for creating a stable variable impedance controller was Ferraguti et al. \cite{ferragutiTankbasedApproachImpedance2013}. By looking at the passivity condition derived for the constant impedance controller (i.e., equation \eqref{eq:variable_impedance_derivative}\footnote{The passivity condition for a constant impedance controller is obtained from equation \eqref{eq:variable_impedance_derivative} by setting $\dot{K}_d$ equal to zero.}), they realized that the dissipation term serves as a passivity margin. The more power dissipated in the system, the stricter the passivity condition becomes, and the more the desired stiffness can be adjusted without threatening the passivity of the closed-loop system. Therefore, by augmenting the impedance model with an energy storing element, a tank, they could track the dissipated energy so that it can be later used to implement the VIC. While doing this, a tank upper limit was set to avoid potentially hazardous situations, and a constant stiffness was used to maintain the closed-loop system's passivity when the energy in the tank is almost empty. This strategy was later extended in \cite{ferragutiEnergyTankBasedInteractive2015} to work with second-order impedance control algorithms that vary not only the desired stiffness but also the desired damping and inertia.

Several works have used this strategy to ensure passivity while varying impedance through adaptive or optimal control \cite{cordoniVariableStochasticAdmittance2020,dietrichPassivationProjectionBasedNull2016,dietrichPassiveHierarchicalImpedance2017,michelPassivitybasedVariableImpedance2020,chenDrawingElonMusk2021,balattiMethodAutonomousRobotic2020,scibiliaSelfAdaptiveRobotControl2018,selvaggioPassiveVirtualFixtures2018,tadeleCombiningEnergyPower2014}. Although theoretically sound from an energy perspective, this method has three main shortcomings:
\begin{enumerate}
    \item A singularity exists when the energy tank is empty. As a result, the tank has to be initialized with a certain amount of energy before the control action. This initialization will make the controller more complex and worsen the performance.
    \item The control performance depends on the tank's initial energy and upper energy bound. These values must be correctly tuned to guarantee a particular variable impedance profile. If the initial energy accumulated in the tank is too low, the controller will run out of energy before the variable impedance profile is completed. If the upper bound is too high, the controller might release too much energy at once, leading to fast and unsafe behaviours.
    \item It depends on the current robot state and can only be applied online. Consequently, the execution of a desired variable impedance profile cannot be guaranteed beforehand because a constant stiffness is used when the tank is almost empty.
\end{enumerate}

To solve the first shortcoming, Zheng et al. \cite{zhengTimeVaryingImpedanceControl2018} modified the energy tank formula with an exponential so that the singularity does not occur anymore when the tank is empty. Saudrais et al. \cite{saudraisRateModeBilateral2021} on the other hand, use a progressive damping injection mechanism to ensure the tank never becomes empty. This mechanism slightly increases the damping parameter to add energy to the tank when the lower limit is reached and decreases it again when the upper bound is reached. Lastly, Secchi et al. \cite{secchiEnergyOptimizationRobust2019} reframed the original impedance control problem as a constraint convex optimisation problem, in which the minimum tank energy is constrained to be above a specific limit. They solve this problem online to retrieve the variable impedance behaviour that best approximates the desired impedance behaviour without depleting the tank. Since their method also plans the (passive) control behaviour closest to the desired one, they not only prevent the singularity from occurring but also improve the performance. This method was later generalised by Capelli et al. \cite{capelliPassivityControlBarrier2022} who encoded this minimum tank energy constraint as a Control Barrier Function (CBF), making it applicable to more control systems.

% NOTE: Schindlbeck et al. 2015, Shahriari et al. 2018/2020 use constant impedance but is added here since it can also be applied to variable impedance.
% NOTE: Shahriari et al. 2018 uses DMP. Mentioned here since this DMP is programmed and not learned and the technique is applicable to variable impedance.
For the second shortcoming, several solutions have been proposed. Schindlbeck et al. \cite{schindlbeckUnifiedPassivitybasedCartesian2015} estimate the energy needed to fulfil the desired task using a linear reaction force model and apply it to the tank to ensure enough energy is in the tank to complete this task. While doing so, a configuration-dependent shaping function on the controller output is used to prevent fast and unsafe behaviour at contact loss. Gerlagh et al. \cite{gerlaghEnergyawareAdaptiveImpedance2021} take a slightly different approach by recovering the required task energy using an offline optimisation. They do not set this energy at the start but gradually release it throughout the motion to ensure the control behaviour is safe. Finally, to prevent the fast and unsafe behaviours mentioned above, Shahriari et al. 2018, 2020 \cite{shahriariValvebasedVirtualEnergy2018,shahriariPowerFlowRegulation2020} limit the power exchanged from the tank at any given time. Shahriari et al. \cite{shahriariValvebasedVirtualEnergy2018} accomplish this by adding adjustable valves into the tank design. By altering the weights of these valves, they can control the power released during task execution. Later, in Shahriari et al. \cite{shahriariPowerFlowRegulation2020}, these valves are replaced by a constraint that directly enforces a specific power exchange profile on the output of the energy tank. This power flow regulation mechanism was used in a later paper by Michel et al. \cite{michelSafetyAwareHierarchicalPassivityBased2022} to satisfy a maximum kinetic energy constraint, thereby ensuring that collisions do not lead to injuries.

\subsection{Potential fields}

While the methods above solve the first two shortcomings of the original energy tank, they significantly complicate the controller design, rely on additional interaction models, slow down the control frequency or hurt the system performance. More importantly, their effectiveness depends on the ability to track the energy dissipated in the system, and their performance cannot be guaranteed for highly-variable environments that might consume all tank energy. As a result, Babarahmati et al. \cite{babarahmatiFractalImpedancePassive2021} replaced the energy tank with an asymptotic stable potential field called a fractal attractor (FA). This FA is used to encode the convergence and divergence behaviour of the variable impedance controller. It accumulates the potential energy of the controller when diverging from the desired state so that it can later be used to converge back to this state passively. In their paper, Barbarahmati combines this FA with a cartesian stiffness controller to form a new (passive) variable impedance controller called a Fractal Impedance Controller (FIC). They use this FIC to execute a non-linear state-dependent variable stiffness profile. This profile could be changed online to enforce a desired impedance relationship without affecting the system's stability and thus guaranteeing stable interaction with unknown environments. Unlike the original energy tank, this new FIC does not need energy dissipation tracking or an energy initialisation method. It also does not rely on energy damping to dissipate energy, achieves a better control performance, and is intrinsically robust against discretisation, model errors, and noise because it is path-independent. It, however, contains a non-smooth force transition while switching from divergence to convergence, which can hurt control performance. Tiseo et al. solved this problem by replacing the stiffness profile with a flexible force profile. This new profile made tuning the controller for different tasks easier, but more importantly, it allowed them to adjust the FA so that the force applied by the FA at the switching point equals the force of this profile, causing a smooth translation between convergence and divergence. In addition, a force-feedback loop was added to the FIC, enabling it to be used with force sensing or tracking tasks such as haptic exploration. This (improved) FIC has since then been deployed successfully in several manipulation and teleoperation tasks \cite{tiseoRobustImpedanceControl2022,tiseoFineManipulationDynamic2022,tiseoAchievingDexterousBidirectional2022,tiseoGeometricalPosturalOptimisation2022,babarahmatiRobustHighTransparencyHaptic2021,tiseoSafeCompliantControl2020}.

\subsection{Stability constraints}

Although potential fields solve most of the shortcomings of the original energy tank, they are still state-dependent. As a result, they, like energy tanks, are not suitable for guaranteeing the execution of a desired variable impedance profile or behaviour in advance. Several authors have therefore used a Lyapunov stability analysis to derive constraints that ensure the stability of their adaptive controllers \cite{leeForceTrackingImpedance2008,linUnifiedMotionForce2021,maFractionalorderSlidingMode2019,maVariableStiffnessDamping2019,sunModelReferenceAdaptive2021,yangHumanlikeAdaptationForce2011,wahballaConstantForceTracking2022,liForceImpedanceTrajectory2018,hamedaniIntelligentImpedanceControl2021,hamedaniRecurrentFuzzyWavelet2021,ganeshVersatileBiomimeticController2012}. These stability constraints are, however, controller specific and can not be used to prove the stability of a general variable impedance profile. Therefore, a paper by Kronander et al. \cite{kronanderStabilityConsiderationsVariable2016} performed a Lyapunov stability analysis on the general variable impedance controller. Using a Lyapunov candidate function, they were able to derive a \textbf{state-independent} stability constraint that relates the desired stiffness and its time derivative to the desired damping. This constraint can be used \textbf{offline} to verify the (asymptotic) stability of a given impedance profile or directly incorporated into an optimization or learning procedure. The resulting profiles can then be executed with any standard impedance control architecture while ensuring that the system cannot go unstable. Alternatively, it can also be implemented as a passivity filter that modifies non-passive impedance profiles \textbf{online} such that the passivity of the closed-loop system is guaranteed \cite{bednarczykPassivityFilterVariable2020}.

Several papers have used the constraint of Kronander et al. \cite{kronanderStabilityConsiderationsVariable2016} with adaptive or optimal control-based variable impedance controllers to ensure stability of the control \cite{fontanelliComparisonAssistiveMethods2018,liuAdaptiveEnhancedAdmittance2022,liangAdaptiveTimeVaryingImpedance2022,heVariableImpedanceControl2020,dongAdaptiveStiffnessDamping2019}. Even though the constraint above guarantees the stability of the control in a state-independent way, it has several limitations. First, because the constraint is very conservative, some stable impedance profiles may be incorrectly classified as unstable, causing the tracking performance to be significantly impacted. To improve this, Bednarczyk et al. \cite{bednarczykPassivityFilterVariable2020} proposed another Lyapunov candidate function that leads to a less conservative stability constraint. Second, the constraint does not consider external forces in the stability analysis. As a result, the (asymptotic) stability of the control system is only guaranteed under the assumption of a free, unconstrained motion. Several papers have, however, derived similar stability constraints on the desired first- and second-order variable impedance dynamics for which AS or ES of the unconstrained motion and ISS or passivity of the constraint motion is proven
\cite{parkInputtoStateStabilityVariable2020,sunStabilityGuaranteedVariableImpedance2021,zhangNeuralApproximationbasedAdaptive2020,bednarczykPassivityFilterVariable2020}. Lastly, Kronander et al. \cite{kronanderStabilityConsiderationsVariable2016} assume that the desired inertia remains constant, which requires correct model knowledge, dynamic decoupling, and external force measurement. As a result, the constraint cannot be used with methods that vary the desired inertia or methods that set the desired inertia equal to the configuration-dependent robot inertia, such as Cartesian stiffness control. To vary the desired inertia, Dong et al. \cite{dongUDEBasedVariableImpedance2019} derived a stability constraint on the desired stiffness, damping, and inertia that can be used to ensure the control system's passivity. Park et al. \cite{parkInputtoStateStabilityVariable2020} instead derived a stability constraint that incorporates the configuration-dependent robot inertia and can therefore be used to guarantee ISS of a Cartesian stiffness controller.
